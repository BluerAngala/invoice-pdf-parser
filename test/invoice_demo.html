<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‘ç¥¨æ™ºèƒ½è¯†åˆ«æ ¸å¯¹ç³»ç»Ÿ</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* é¡¶éƒ¨å¯¼èˆª */
      .header {
        padding: 12px 24px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        z-index: 10;
      }
      .header h2 {
        margin: 0;
        font-size: 18px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .upload-btn {
        padding: 8px 20px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
      }
      .upload-btn:hover {
        background: #1d4ed8;
      }

      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
        background: #f8fafc;
      }

      /* å·¦ä¾§é¢„è§ˆåŒº */
      .preview-pane {
        flex: 1;
        background: #525659;
        overflow: auto;
        display: flex;
        justify-content: center;
        padding: 30px;
        position: relative;
      }
      #pdfCanvas {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        max-width: 100%;
        height: auto;
        align-self: flex-start;
        background: #fff;
      }
      .empty-tip {
        color: #bbb;
        align-self: center;
        font-size: 16px;
        text-align: center;
        line-height: 1.5;
      }

      /* å³ä¾§ç¼–è¾‘åŒº */
      .edit-pane {
        width: 400px;
        min-width: 350px;
        background: #fff;
        border-left: 1px solid #e0e0e0;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        box-shadow: -4px 0 12px rgba(0, 0, 0, 0.03);
        z-index: 5;
      }

      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        font-size: 13px;
        color: #64748b;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        transition: all 0.2s;
        color: #334155;
      }
      .form-group input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
      }

      .section-title {
        font-size: 15px;
        font-weight: 700;
        border-left: 4px solid #2563eb;
        padding-left: 10px;
        margin: 24px 0 16px 0;
        color: #1e293b;
        display: flex;
        align-items: center;
      }
      .section-title:first-child {
        margin-top: 0;
      }

      .debug-info {
        margin-top: auto;
        border-top: 1px solid #f1f5f9;
        padding-top: 20px;
        font-size: 12px;
        color: #94a3b8;
      }
      .debug-log {
        max-height: 100px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 10px;
      }

      /* çŠ¶æ€æŒ‡ç¤º */
      .status-bar {
        padding: 10px 14px;
        background: #dcfce7;
        color: #166534;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
        font-size: 14px;
        align-items: center;
        gap: 8px;
        border: 1px solid #bbf7d0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h2>ğŸ§¾ å‘ç¥¨æ™ºèƒ½è¯†åˆ«æ ¸å¯¹</h2>
      <div>
        <input
          type="file"
          id="fileInput"
          accept=".pdf"
          style="display: none"
          onchange="handleFile(this.files[0])"
        />
        <button
          class="upload-btn"
          onclick="document.getElementById('fileInput').click()"
        >
          ğŸ“‚ ä¸Šä¼  PDF å‘ç¥¨
        </button>
      </div>
    </div>

    <div class="main-container">
      <!-- å·¦ä¾§é¢„è§ˆ -->
      <div class="preview-pane" id="previewContainer">
        <div class="empty-tip" id="emptyTip">
          <div style="font-size: 40px; margin-bottom: 10px">ğŸ“„</div>
          è¯·ç‚¹å‡»å³ä¸Šè§’ä¸Šä¼ æŒ‰é’®<br />é€‰æ‹© PDF ç”µå­å‘ç¥¨è¿›è¡Œè¯†åˆ«ä¸é¢„è§ˆ
        </div>
        <canvas id="pdfCanvas" style="display: none"></canvas>
      </div>

      <!-- å³ä¾§æ ¸å¯¹ -->
      <div class="edit-pane">
        <div id="statusMsg" class="status-bar">
          âœ… è¯†åˆ«æˆåŠŸï¼Œè¯·æ ¸å¯¹å¹¶ä¿®æ”¹ä¸‹æ–¹ä¿¡æ¯
        </div>

        <div class="section-title">ğŸ’° é‡‘é¢ä¿¡æ¯</div>
        <div class="form-group">
          <label>ä»·ç¨åˆè®¡ (å°å†™)</label>
          <input
            type="text"
            id="amount"
            style="color: #dc2626; font-weight: bold; font-size: 18px"
          />
        </div>

        <div class="section-title">ğŸ“ åŸºç¡€ä¿¡æ¯</div>
        <div class="form-group">
          <label>å‘ç¥¨å·ç </label>
          <input type="text" id="invoiceNum" />
        </div>
        <div class="form-group">
          <label>å‘ç¥¨ä»£ç </label>
          <input type="text" id="invoiceCode" />
        </div>
        <div class="form-group">
          <label>å¼€ç¥¨æ—¥æœŸ</label>
          <input type="text" id="dateStr" />
        </div>
        <div class="form-group">
          <label>æ ¡éªŒç </label>
          <input type="text" id="checkCode" />
        </div>

        <div class="section-title">ğŸ¢ äº¤æ˜“æ–¹ä¿¡æ¯</div>
        <div class="form-group">
          <label>è´­ä¹°æ–¹åç§°</label>
          <input type="text" id="purchaserName" />
        </div>
        <div class="form-group">
          <label>é”€å”®æ–¹åç§°</label>
          <input type="text" id="sellerName" />
        </div>

        <div class="debug-info">
          <div>ğŸ› ï¸ è°ƒè¯•æ—¥å¿—</div>
          <div id="logs" class="debug-log">ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...</div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨ ES Module å¼•å…¥æœ€æ–°ç‰ˆ PDF.js -->
    <script type="module">
      import * as pdfjsLib from "./pdfjs-5.4.449-dist/build/pdf.mjs";

      // é…ç½® Worker (å¿…é¡»ä¹Ÿæ˜¯ ES Module ç‰ˆæœ¬)
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "./pdfjs-5.4.449-dist/build/pdf.worker.mjs";

      // å°† handleFile æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œä»¥ä¾¿ HTML ä¸­çš„ onchange å¯ä»¥è°ƒç”¨
      window.handleFile = async function (file) {
        if (!file) return;

        const statusMsg = document.getElementById("statusMsg");
        const logsDiv = document.getElementById("logs");
        const emptyTip = document.getElementById("emptyTip");
        const canvas = document.getElementById("pdfCanvas");

        // é‡ç½®ç•Œé¢
        statusMsg.style.display = "none";
        logsDiv.innerHTML = "æ­£åœ¨è¯»å–æ–‡ä»¶...";

        try {
          const arrayBuffer = await file.arrayBuffer();
          const loadingTask = pdfjsLib.getDocument({
            data: arrayBuffer,
            cMapUrl: "./pdfjs-5.4.449-dist/web/cmaps/",
            cMapPacked: true,
          });
          const pdf = await loadingTask.promise;
          const page = await pdf.getPage(1);

          // 1. æ¸²æŸ“é¢„è§ˆå›¾
          logsDiv.innerHTML += "\næ­£åœ¨æ¸²æŸ“é¢„è§ˆ...";
          const scale = 1.5;
          const viewport = page.getViewport({ scale });
          const context = canvas.getContext("2d");

          canvas.height = viewport.height;
          canvas.width = viewport.width;

          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };
          await page.render(renderContext).promise;

          canvas.style.display = "block";
          emptyTip.style.display = "none";

          // 2. æå–æ–‡æœ¬æ•°æ®
          logsDiv.innerHTML += "\næ­£åœ¨æå–æ–‡æœ¬...";
          const textContent = await page.getTextContent();
          const items = textContent.items;

          // æ’åºé€»è¾‘
          items.sort((a, b) => {
            const yA = a.transform[5];
            const yB = b.transform[5];
            const xA = a.transform[4];
            const xB = b.transform[4];
            if (Math.abs(yA - yB) > 5) return yB - yA;
            return xA - xB;
          });

          const fullText = items.map((item) => item.str).join("");

          // æå–è¾…åŠ©å‡½æ•°
          const extract = (regex, text, groupIndex = 1) => {
            const match = text.match(regex);
            return match ? match[groupIndex].trim() : "";
          };

          // --- å­—æ®µæå–é€»è¾‘ ---

          // åŸºç¡€å­—æ®µ
          const invoiceNumMatch = fullText.match(
            /(?:å‘ç¥¨å·ç |å·ç )[:ï¼š]?\s*(\d{20}|\d{8,12})/
          );
          const invoiceNum = invoiceNumMatch ? invoiceNumMatch[1] : "";

          let invoiceCode = "æ— éœ€ (å…¨ç”µå‘ç¥¨)";
          if (!invoiceNum || invoiceNum.length !== 20) {
            const codeMatch = fullText.match(/å‘ç¥¨ä»£ç [:ï¼š]?\s*(\d{10,12})/);
            invoiceCode = codeMatch ? codeMatch[1] : "";
          }

          let dateStr = "";
          const dateMatch = fullText.match(
            /(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/
          );
          if (dateMatch)
            dateStr = `${dateMatch[1]}å¹´${dateMatch[2]}æœˆ${dateMatch[3]}æ—¥`;

          let checkCode = extract(/æ ¡éªŒç [:ï¼š]?\s*([\d\s]{20,})/, fullText);
          if (checkCode) checkCode = checkCode.replace(/\s/g, "");
          if (!checkCode && invoiceNum.length === 20)
            checkCode = "æ— éœ€ (å…¨ç”µå‘ç¥¨)";

          // é‡‘é¢å­—æ®µ
          let amount = "";
          const totalAmountReg =
            /ä»·ç¨åˆè®¡[\s\S]*?å°å†™.*?[Â¥ï¿¥:ï¼š]\s*([0-9,]+\.\d{2})/;
          const totalMatch = fullText.match(totalAmountReg);
          if (totalMatch) {
            amount = totalMatch[1];
          } else {
            const lowerCaseMatch = fullText.match(
              /\(å°å†™\)[:ï¼š]?\s*[Â¥ï¿¥]?\s*([0-9,]+\.\d{2})/
            );
            amount = lowerCaseMatch ? lowerCaseMatch[1] : "";
            if (!amount) {
              const moneyPattern = /[0-9,]+\.\d{2}/g;
              let maxVal = 0;
              let match;
              while ((match = moneyPattern.exec(fullText)) !== null) {
                let val = parseFloat(match[0].replace(/,/g, ""));
                if (val > maxVal && val < 1000000000) {
                  maxVal = val;
                  amount = match[0];
                }
              }
            }
          }

          // äº¤æ˜“æ–¹å­—æ®µ (åˆ†æ ç­–ç•¥)
          let purchaserName = "";
          let sellerName = "";

          let maxX = 0;
          items.forEach((item) => {
            if (item.transform[4] > maxX) maxX = item.transform[4];
          });
          const midX = maxX / 2 || 300;

          const leftItems = items.filter((item) => item.transform[4] < midX);
          const rightItems = items.filter((item) => item.transform[4] >= midX);

          const findValueInColumn = (columnItems, labelRegex) => {
            for (let i = 0; i < columnItems.length; i++) {
              const item = columnItems[i];
              if (labelRegex.test(item.str)) {
                let value = "";
                const match = item.str.match(labelRegex);
                const selfContent = item.str.replace(match[0], "").trim();
                if (selfContent.length > 1) value = selfContent;

                for (let j = i + 1; j < columnItems.length; j++) {
                  const nextItem = columnItems[j];
                  if (Math.abs(nextItem.transform[5] - item.transform[5]) > 4)
                    break;
                  value += nextItem.str;
                }
                if (value.trim()) return value.trim();
              }
            }
            return null;
          };

          purchaserName =
            findValueInColumn(leftItems, /åç§°[:ï¼š]/) ||
            findValueInColumn(leftItems, /è´­\s*ä¹°\s*æ–¹/) ||
            "";
          sellerName =
            findValueInColumn(rightItems, /åç§°[:ï¼š]/) ||
            findValueInColumn(rightItems, /é”€\s*å”®\s*æ–¹/) ||
            "";

          // 3. å¡«å……è¡¨å•
          document.getElementById("invoiceNum").value = invoiceNum;
          document.getElementById("invoiceCode").value = invoiceCode;
          document.getElementById("dateStr").value = dateStr;
          document.getElementById("checkCode").value = checkCode;
          document.getElementById("amount").value = amount;
          document.getElementById("purchaserName").value = purchaserName;
          document.getElementById("sellerName").value = sellerName;

          // æ‰“å°è¯†åˆ«ç»“æœåˆ°æ§åˆ¶å°
          console.log("--- å‘ç¥¨è¯†åˆ«ç»“æœ ---");
          console.log("ğŸ’° ä»·ç¨åˆè®¡:", amount);
          console.log("ğŸ“… å¼€ç¥¨æ—¥æœŸ:", dateStr);
          console.log("ğŸ”¢ å‘ç¥¨ä»£ç :", invoiceCode);
          console.log("ğŸ“„ å‘ç¥¨å·ç :", invoiceNum);
          console.log("âœ… æ ¡éªŒç :", checkCode);
          console.log("ğŸ‘¤ è´­ä¹°æ–¹:", purchaserName);
          console.log("ğŸª é”€å”®æ–¹:", sellerName);
          console.log("--------------------");

          // å®ŒæˆçŠ¶æ€
          statusMsg.style.display = "flex";
          logsDiv.innerHTML = `è§£æå®Œæˆ! æ‰¾åˆ° ${items.length} ä¸ªæ–‡æœ¬ç‰‡æ®µã€‚`;
        } catch (error) {
          console.error(error);
          logsDiv.innerHTML = `é”™è¯¯: ${error.message}`;
          alert("è§£æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æˆ–æ—¥å¿—");
        }
      };
    </script>
  </body>
</html>
